{% extends "base.html" %}

{% block title %}Read {{ book.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">{{ book.title }} <small class="text-muted">by {{ book.author }}</small></h2>
    <div class="alert alert-info">PDF URL: <span id="pdf-url-span">{{ pdf_url }}</span></div>
    <div id="pdf-controls" class="mb-3 d-flex align-items-center justify-content-center">
        <button id="prev" class="btn btn-secondary btn-lg me-2">Previous</button>
        <span>Page <span id="page_num">1</span> / <span id="page_count">?</span></span>
        <button id="next" class="btn btn-secondary btn-lg ms-2">Next</button>
        <button id="zoom_in" class="btn btn-outline-primary btn-lg ms-4">+</button>
        <button id="zoom_out" class="btn btn-outline-primary btn-lg ms-2">-</button>
    </div>
    <div id="pdf-viewer" class="d-flex justify-content-center align-items-center" style="min-height: 70vh;">
        <canvas id="pdf-canvas" style="border:1px solid #ccc; max-width:100%; max-height:80vh;"></canvas>
    </div>
    <div class="mt-3">
        <a href="{{ url_for('book_detail', book_id=book.id) }}" class="btn btn-outline-primary">Back to Book Details</a>
    </div>
</div>

<!-- PDF.js ES Module integration -->
<div id="pdfjs-error" style="display:none;color:red;text-align:center;margin-top:1em;"></div>
<script type="module">
    import * as pdfjsLib from "{{ url_for('static', filename='js/pdf.mjs') }}";
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='js/pdf.worker.mjs') }}";
    const url = "{{ pdf_url }}";
    document.getElementById('pdf-url-span').textContent = url;
    let pdfDoc = null,
        pageNum = 1,
        pageRendering = false,
        pageNumPending = null,
        scale = 1.2,
        canvas = document.getElementById('pdf-canvas'),
        ctx = canvas.getContext('2d');

    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            let viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            let renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            let renderTask = page.render(renderContext);
            renderTask.promise.then(function() {
                pageRendering = false;
                document.getElementById('page_num').textContent = num;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            }).catch(function(err) {
                showPdfError('Error rendering page: ' + err.message);
                console.error('PDF.js render error:', err);
            });
        }).catch(function(err) {
            showPdfError('Error loading page: ' + err.message);
            console.error('PDF.js page error:', err);
        });
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }
    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }
    function onZoomIn() {
        scale = Math.min(scale + 0.2, 3.0);
        queueRenderPage(pageNum);
    }
    function onZoomOut() {
        scale = Math.max(scale - 0.2, 0.5);
        queueRenderPage(pageNum);
    }

    function showPdfError(msg) {
        const errDiv = document.getElementById('pdfjs-error');
        errDiv.style.display = 'block';
        errDiv.innerHTML = '<b>PDF Viewer Error:</b> ' + msg + '<br>PDF URL: ' + url;
    }

    // Use pdfjsLib for compatibility
    if (typeof pdfjsLib.getDocument === 'function') {
        console.log('PDF.js version:', pdfjsLib.version || 'unknown');
        console.log('PDF URL:', url);
        pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
            pdfDoc = pdfDoc_;
            document.getElementById('page_count').textContent = pdfDoc.numPages;
            renderPage(pageNum);
        }).catch(function(error) {
            showPdfError('Failed to load PDF: ' + error.message);
            console.error('PDF.js error:', error);
        });
    } else {
        showPdfError('PDF.js library failed to load.');
        console.error('PDF.js library is not available.');
    }

    document.getElementById('prev').addEventListener('click', onPrevPage);
    document.getElementById('next').addEventListener('click', onNextPage);
    document.getElementById('zoom_in').addEventListener('click', onZoomIn);
    document.getElementById('zoom_out').addEventListener('click', onZoomOut);
</script>
{% endblock %}
